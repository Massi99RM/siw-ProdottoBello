<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProdottoBello - Il Mio Profilo</title>
    <link rel="stylesheet" th:href="@{/css/stile.css}">
</head>
<body>
	<header class="site-header">
		    <a href="/">Home</a> | 
		    <a href="/catalog">Catalogo</a> | 
		    <span th:if="${#authorization.expression('isAuthenticated()')}">
		        <a href="/profile">Profilo</a> |
		        <span th:if="${#authorization.expression('hasRole(''ADMIN'')')}">
		            <a href="/admin">Admin</a> |
		        </span>
		        <a href="/logout">Logout (<span th:text="${#authentication.name}">username</span>)</a>
		    </span>
		    <span th:if="${#authorization.expression('isAnonymous()')}">
		        <a href="/login">Login</a> | 
		        <a href="/register">Registrati</a>
		    </span>
		</header>

    <main class="site-main">
        <div class="profile-container">
            <h1>Il Mio Profilo</h1>   
            <!-- Informazioni utente -->
            <div class="profile-section">
                <h2>Informazioni Personali</h2>
                <div class="user-info">
                    <div class="info-item">
                        <strong>Nome Completo:</strong>
                        <span th:text="${user.fullName}">Nome Cognome</span>
                    </div>
                    <div class="info-item">
                        <strong>Username:</strong>
                        <span th:text="${user.username}">username</span>
                    </div>
                    <div class="info-item">
                        <strong>Email:</strong>
                        <span th:text="${user.email}">email@example.com</span>
                    </div>
                    <div class="info-item">
                        <strong>Ruolo:</strong>
                        <span th:text="${user.role.displayName}" class="role-badge" th:class="'role-badge role-' + ${user.role.name().toLowerCase()}">Utente</span>
                    </div>
                    <div class="info-item">
                        <strong>Registrato il:</strong>
                        <span th:text="${#temporals.format(user.createdAt, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</span>
                    </div>
					
					<!-- Pannello Admin (solo per amministratori) -->
					<div class="profile-section" th:if="${user.role.name() == 'ADMIN'}">
					    <h2>Pannello Amministrazione</h2>
					    <div class="admin-actions">
					        <a href="/admin/products" class="btn-primary">Gestisci Prodotti</a>
					        <a href="/admin/dashboard" class="btn-primary">Dashboard Admin</a>
					    </div>
					</div>
                    <div class="info-item" th:if="${user.lastLogin}">
                        <strong>Ultimo accesso:</strong>
                        <span th:text="${#temporals.format(user.lastLogin, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</span>
                    </div>
                </div>
            </div>
			
			<!-- Sezione commenti visibile solo agli utenti base -->
			<div class="profile-section" 
			     th:if="${#authorization.expression('isAuthenticated() and hasRole(''USER'')')} and ${comments != null}">
			    <h2>I Tuoi Commenti</h2>
			    <div class="user-comments">
			        <div th:each="comment : ${comments}">
			            <p>
			                <strong th:text="${comment.product.name}">Prodotto</strong>:
			                <span th:text="${comment.content}">Contenuto del commento</span>
			            </p>
			        </div>
			    </div>
			</div>


            <!-- Modifica profilo -->
            <div class="profile-section">
                <h2>Modifica Informazioni</h2>
                
                <!-- Messaggi di successo/errore -->
                <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}">
                    Profilo aggiornato
                </div>
                <div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}">
                    Errore aggiornamento
                </div>
                
                <form action="/profile/update" method="post" class="profile-form">
					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">Nome:</label>
                            <input type="text" 
                                   id="firstName" 
                                   name="firstName" 
                                   th:value="${user.firstName}"
                                   required 
                                   class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="lastName">Cognome:</label>
                            <input type="text" 
                                   id="lastName" 
                                   name="lastName" 
                                   th:value="${user.lastName}"
                                   required 
                                   class="form-input">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" 
                               id="email" 
                               name="email" 
                               th:value="${user.email}"
                               required 
                               class="form-input">
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn-primary">
                            Aggiorna Informazioni
                        </button>
                    </div>
                </form>
            </div>

            <!-- Cambio password -->
            <div class="profile-section">
                <h2>Cambia Password</h2>
                
                <!-- Messaggi password -->
                <div th:if="${passwordSuccess}" class="alert alert-success" th:text="${passwordSuccess}">
                    Password cambiata
                </div>
                <div th:if="${passwordError}" class="alert alert-error" th:text="${passwordError}">
                    Errore password
                </div>
                
                <form action="/profile/change-password" method="post" class="profile-form">
					<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <div class="form-group">
                        <label for="currentPassword">Password Attuale:</label>
                        <input type="password" 
                               id="currentPassword" 
                               name="currentPassword" 
                               required 
                               class="form-input"
                               placeholder="Inserisci la password attuale">
                    </div>
                    
                    <div class="form-group">
                        <label for="newPassword">Nuova Password:</label>
                        <input type="password" 
                               id="newPassword" 
                               name="newPassword" 
                               required 
                               minlength="6"
                               class="form-input"
                               placeholder="Inserisci la nuova password (min 6 caratteri)">
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmNewPassword">Conferma Nuova Password:</label>
                        <input type="password" 
                               id="confirmNewPassword" 
                               name="confirmNewPassword" 
                               required 
                               class="form-input"
                               placeholder="Ripeti la nuova password">
                        <div id="password-match" class="field-feedback"></div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn-primary" id="change-password-btn">
                            Cambia Password
                        </button>
                    </div>
                </form>
            </div>
    </main>

    <!-- JavaScript per validazione password -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const newPasswordInput = document.getElementById('newPassword');
            const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
            const feedback = document.getElementById('password-match');
            const submitBtn = document.getElementById('change-password-btn');
            
            function checkPasswordMatch() {
                if (newPasswordInput.value === '' || confirmNewPasswordInput.value === '') {
                    feedback.textContent = '';
                    submitBtn.disabled = false;
                    return;
                }
                
                if (newPasswordInput.value === confirmNewPasswordInput.value) {
                    feedback.textContent = '✓ Le password corrispondono';
                    feedback.className = 'field-feedback success';
                    submitBtn.disabled = false;
                } else {
                    feedback.textContent = '✗ Le password non corrispondono';
                    feedback.className = 'field-feedback error';
                    submitBtn.disabled = true;
                }
            }
            
            newPasswordInput.addEventListener('input', checkPasswordMatch);
            confirmNewPasswordInput.addEventListener('input', checkPasswordMatch);
        });
    </script>
</body>
</html>